# db.py
import psycopg2
import streamlit as st

# ===============================
# 1. إعدادات الاتصال بـ Neon
# ===============================
CONNECTION_STRING = "postgresql://neondb_owner:npg_xemW42zBHjwi@ep-broad-waterfall-adekol3k-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"

def connect_db():
    """الاتصال بقاعدة Neon"""
    try:
        conn = psycopg2.connect(CONNECTION_STRING)
        return conn
    except Exception as e:
        st.error(f"❌ فشل الاتصال بقاعدة البيانات: {e}")
        return None

# ===============================
# 2. دالة حفظ البيانات
# ===============================
def save_to_db(extracted_data):
    """
    حفظ بيانات التقرير المالي في جدول suspects.
    يقوم بتحويل المفاتيح غير المتوافقة (مثل المسافات أو /) إلى أسماء الأعمدة المناسبة.
    """
    conn = connect_db()
    if not conn:
        return False

    try:
        cur = conn.cursor()

        # تحويل المفاتيح لتناسب الأعمدة في Neon
        data = {
            "رقم_الصادر": extracted_data.get("رقم الصادر", "غير متوفر"),
            "تاريخ_الصادر": extracted_data.get("تاريخ الصادر", "غير متوفر"),
            "اسم_المشتبه_به": extracted_data.get("اسم المشتبه به", "غير متوفر"),
            "رقم_الهوية": extracted_data.get("رقم الهوية", "غير متوفر"),
            "الجنسية": extracted_data.get("الجنسية", "غير متوفر"),
            "تاريخ_الميلاد_الوافد": extracted_data.get("تاريخ الميلاد الوافد", "غير متوفر"),
            "تاريخ_الدخول": extracted_data.get("تاريخ الدخول", "غير متوفر"),
            "الحالة_الاجتماعية": extracted_data.get("الحالة الاجتماعية", "غير متوفر"),
            "المهنة": extracted_data.get("المهنة", "غير متوفر"),
            "رقم_الجوال": extracted_data.get("رقم الجوال", "غير متوفر"),
            "المدينة": extracted_data.get("المدينة", "غير متوفر"),
            "رصيد_الحساب": extracted_data.get("رصيد الحساب", "غير متوفر"),
            "الدخل_السنوي": extracted_data.get("الدخل السنوي", "غير متوفر"),
            "رقم_الوارد": extracted_data.get("رقم الوارد", "غير متوفر"),
            "تاريخ_الوارد": extracted_data.get("تاريخ الوارد", "غير متوفر"),
            "رقم_صاحب_العمل": extracted_data.get("رقم صاحب العمل/ السجل التجاري", "غير متوفر"),
            "سبب_الاشتباه": extracted_data.get("سبب الاشتباه", "غير متوفر"),
            "تاريخ_الدراسة_من": extracted_data.get("تاريخ الدارسة من", "غير متوفر"),
            "تاريخ_الدراسة_الى": extracted_data.get("تاريخ الدراسة الى", "غير متوفر"),
            "اجمالي_الايداع": extracted_data.get("إجمالي الإيداع على الحساب اثناء الدراسة", "غير متوفر"),
            "اسم_الملف": extracted_data.get("اسم الملف", "غير متوفر"),
            "وقت_الاستخلاص": extracted_data.get("وقت الاستخلاص", "غير متوفر")
        }

        insert_query = """
            INSERT INTO suspects (
                رقم_الصادر, تاريخ_الصادر, اسم_المشتبه_به, رقم_الهوية,
                الجنسية, تاريخ_الميلاد_الوافد, تاريخ_الدخول, الحالة_الاجتماعية,
                المهنة, رقم_الجوال, المدينة, رصيد_الحساب, الدخل_السنوي,
                رقم_الوارد, تاريخ_الوارد, رقم_صاحب_العمل, سبب_الاشتباه,
                تاريخ_الدراسة_من, تاريخ_الدراسة_الى, اجمالي_الايداع,
                اسم_الملف, وقت_الاستخلاص
            ) VALUES (
                %(رقم_الصادر)s, %(تاريخ_الصادر)s, %(اسم_المشتبه_به)s, %(رقم_الهوية)s,
                %(الجنسية)s, %(تاريخ_الميلاد_الوافد)s, %(تاريخ_الدخول)s, %(الحالة_الاجتماعية)s,
                %(المهنة)s, %(رقم_الجوال)s, %(المدينة)s, %(رصيد_الحساب)s, %(الدخل_السنوي)s,
                %(رقم_الوارد)s, %(تاريخ_الوارد)s, %(رقم_صاحب_العمل)s, %(سبب_الاشتباه)s,
                %(تاريخ_الدراسة_من)s, %(تاريخ_الدراسة_الى)s, %(اجمالي_الايداع)s,
                %(اسم_الملف)s, %(وقت_الاستخلاص)s
            )
        """

        cur.execute(insert_query, data)
        conn.commit()
        cur.close()
        conn.close()
        return True

    except Exception as e:
        st.error(f"❌ حدث خطأ أثناء حفظ البيانات: {e}")
        return False
