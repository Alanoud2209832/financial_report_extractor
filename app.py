import streamlit as st
import pandas as pd
import firebase_admin
from firebase_admin import credentials, firestore
from google import genai
from arabic_reshaper import reshape
from bidi.algorithm import get_display

# ----------------------------------------------------------------------
# 1. ุฅุนุฏุงุฏ ููุชุงุญ Gemini API (ูุทููุจ: ุงุณุชุฎุฏูู ุงูููุชุงุญ ุงูุฌุฏูุฏ)
# ----------------------------------------------------------------------
# ๐จ ููุงุญุธุฉ ูุงูุฉ: ูุฌุจ ูุตู ููุชุงุญ Gemini API ุงูุฌุฏูุฏ ูุงูุตุงูุญ ููุง.
GEMINI_API_KEY = "AIzaSyCeNFMTQjPhKMk0hN5qA_Lk-256RpExmN0" # โฌ๏ธ ุงูุตูู ุงูููุชุงุญ ุงูุฌุฏูุฏ ููุง

# ----------------------------------------------------------------------
# 2. ุฅุนุฏุงุฏ ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุจูุงูุงุช Firestore
# ----------------------------------------------------------------------

# ุงูุชุญูู ูู ุงูุชููุฆุฉ ูุชุฌูุจ ุงูุฎุทุฃ ุฅุฐุง ุชู ุงูุชููุฆุฉ ูุณุจูุงู
if not firebase_admin._apps:
    try:
        # Streamlit ููุฑุฃ ุงูุจูุงูุงุช ูู ููู .streamlit/secrets.toml
        # ูุฌุจ ุฃู ูููู ููุชุงุญ 'firestore' ูู ููุณ ุงุณู ุงูุฌุฏูู ูู secrets.toml
        cred = credentials.Certificate(st.secrets["firestore"])
        firebase_admin.initialize_app(cred)
        st.session_state['db'] = firestore.client()
        st.success("ุชู ุงูุงุชุตุงู ุจู Firestore ุจูุฌุงุญ!")
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Firestore. ุชุฃูุฏ ูู ูุฌูุฏ ุงูููู .streamlit/secrets.toml ุจุงูุตูุบุฉ ุงูุตุญูุญุฉ. ุงูุฎุทุฃ: {e}")
        st.session_state['db'] = None
else:
    st.session_state['db'] = firestore.client()

# ----------------------------------------------------------------------
# 3. ุงูุฏูุงู ุงููุณุงุนุฏุฉ ููุบุฉ ุงูุนุฑุจูุฉ
# ----------------------------------------------------------------------
def fix_arabic(text):
    """ูุตูุญ ุนุฑุถ ุงููุตูุต ุงูุนุฑุจูุฉ ูู Streamlit."""
    return get_display(reshape(str(text)))

# ----------------------------------------------------------------------
# 4. ูุงุฌูุฉ ุงูุชุทุจูู ุงูุฑุฆูุณูุฉ
# ----------------------------------------------------------------------
st.set_page_config(layout="wide", page_title=fix_arabic("ูุญูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุฐูู"))

st.title(fix_arabic("ูุญูู ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงููุฏุนูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู"))

# ----------------------------------------------------------------------
# 5. ููุทูุฉ ุชุญููู ุงููููุงุช
# ----------------------------------------------------------------------
uploaded_file = st.file_uploader(fix_arabic("ุชุญููู ุงูุชูุฑูุฑ ุงููุงูู (PDF ุฃู CSV)"), type=["pdf", "csv"])

if uploaded_file is not None:
    st.success(fix_arabic(f"ุชู ุชุญููู ุงูููู ุจูุฌุงุญ: {uploaded_file.name}"))
    
    # ----------------------------------------------------------------------
    # 6. ูุนุงูุฌุฉ ุงููููุงุช ูุชุญููููุง (ูุฌุจ ุงุณุชููุงู ูุฐู ุงูููุทูุฉ ุจูุงุกู ุนูู ูุชุทูุจุงุช ุงูุชุญููู)
    # ----------------------------------------------------------------------
    if 'analysis_done' not in st.session_state:
        st.session_state['analysis_done'] = False
        st.session_state['report_data'] = None

    if st.button(fix_arabic("ุจุฏุก ุงูุชุญููู")):
        # ูุฐู ุฎุทูุฉ ุชุญููููุฉ ุงูุชุฑุงุถูุฉ. ุณุชุญุชุงุฌ ุฅูู ุฏูุฌ Gemini Vision ููุง ูุชุญููู PDF
        # ุฃู ุชุญููู ุจูุงูุงุช CSV/Excel
        
        # ูููุชุฑุถ ุฃู ุงูุชุญููู ูุฎุฑุฌ ุจููุฎุต:
        summary = {
            "ุงุณู_ุงูุชูุฑูุฑ": uploaded_file.name,
            "ุชุงุฑูุฎ_ุงูุชุญููู": pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S"),
            "ููุฎุต_ุงููุชุงุฆุฌ": fix_arabic("ููุฎุต ููุตู ููุชูุฑูุฑ ุงููุงูู ูุน ุชุญุฏูุฏ ูุคุดุฑุงุช ุงูุฎุทุฑ."),
            "ูุคุดุฑุงุช_ุงูุฎุทุฑ": fix_arabic("ุนุฏู ุชูุงุณุจ ุญุฌู ุงูุนูููุงุช ูุน ุงูุฏุฎู ุงููุนูู."),
        }
        
        st.session_state['report_data'] = summary
        st.session_state['analysis_done'] = True
        st.session_state['file_name'] = uploaded_file.name

    if st.session_state['analysis_done']:
        st.subheader(fix_arabic("ูุชุงุฆุฌ ุงูุชุญููู"))
        data = st.session_state['report_data']
        
        # ุนุฑุถ ุงููุชุงุฆุฌ
        st.json(data)

        # ----------------------------------------------------------------------
        # 7. ูุธููุฉ ุญูุธ ุงูุจูุงูุงุช ูู Firestore
        # ----------------------------------------------------------------------
        if st.session_state['db'] is not None and st.button(fix_arabic("ุญูุธ ุงูุชูุฑูุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช")):
            try:
                db = st.session_state['db']
                # ูุญุฏุฏ ุงููุณุงุฑ ุงูุฐู ุณุชูุญูุธ ููู ุงูุจูุงูุงุช ูู Firestore
                # ุงููุณุงุฑ ุงููุชุจุน: artifacts/{app_id}/reports/{file_name}
                reports_collection = db.collection("artifacts").document("project-6a5a2").collection("reports")
                
                # ุฅุถุงูุฉ ุงูุจูุงูุงุช ูู ูุณุชูุฏ ุฌุฏูุฏ
                reports_collection.add(data)
                
                st.success(fix_arabic("ุชู ุญูุธ ุงูุชูุฑูุฑ ุจูุฌุงุญ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช!"))
                
                # ุชุญุฏูุซ ุญุงูุฉ ุงูุชุญูู ุงููุฏูู
                st.info(fix_arabic("ูุฑุฌู ุงูุขู ุฒูุงุฑุฉ Firebase Console ููุชุฃูุฏ ูู ุธููุฑ ูุฌููุนุฉ 'artifacts' ููุฌููุนุฉ 'reports' ุฏุงุฎููุง."))

            except Exception as e:
                st.error(fix_arabic(f"ูุดู ุญูุธ ุงูุจูุงูุงุช: {e}"))
                st.warning(fix_arabic("ุชุฃูุฏ ูู ุฃูู ููุช ุจุฅูุดุงุก ููู '.streamlit/secrets.toml' ุจุดูู ุตุญูุญ."))


# ----------------------------------------------------------------------
# 8. ุดุงุดุฉ ุงูุจุฏุก (ุนูุฏ ุนุฏู ูุฌูุฏ ููู ููุญููู)
# ----------------------------------------------------------------------
if uploaded_file is None:
    st.info(fix_arabic("ูุฑุฌู ุชุญููู ุชูุฑูุฑ ูุงูู ูุจุฏุก ุงูุชุญููู. ูุฏุนู ุงููููุงุช ุจุตูุบุฉ PDF ู CSV."))

# ----------------------------------------------------------------------
# 9. ุชุฐููุฑ ุญุงูุฉ ุงูููุชุงุญ
# ----------------------------------------------------------------------
if GEMINI_API_KEY == "AIzaSy...":
    st.warning(fix_arabic("ุชุฐููุฑ: ูุฌุจ ุงุณุชุจุฏุงู 'AIzaSy...' ุจููุชุงุญ Gemini API ุงูุตุงูุญ ุงูุฌุฏูุฏ ูุจุฏุก ุงูุชุญููู ุงููุนูู."))
