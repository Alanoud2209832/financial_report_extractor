import streamlit as st
import pandas as pd
from google import genai
from google.genai import types
from google.genai.errors import APIError
from arabic_reshaper import reshape
from bidi.algorithm import get_display
import os
import json
import io
import sys
import xlsxwriter # ุงูููุชุจุฉ ุงูุถุฑูุฑูุฉ ูุฅูุดุงุก ูููุงุช Excel

# ----------------------------------------------------------------
# 1. ุฅุนุฏุงุฏุงุช API ุงูุขููุฉ (ููุฑุฃ ุงูููุชุงุญ ูู st.secrets ุนูุฏ ุงููุดุฑ)
# ----------------------------------------------------------------

# ูููู ุจูุฑุงุกุฉ ุงูููุชุงุญ ุงูุขูู ูู ุฅุนุฏุงุฏุงุช Streamlit Cloud (st.secrets)
try:
    API_KEY = st.secrets["gemini_api_key"]
    os.environ['GEMINI_API_KEY'] = API_KEY
    client = genai.Client(api_key=API_KEY)
except (AttributeError, KeyError):
    # ุฑุณุงูุฉ ุฎุทุฃ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุชุธูุฑ ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุงุญ
    st.error(get_display(reshape("๐จ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุชุงุญ ูู Streamlit Secrets. ุงูุฑุฌุงุก ุงูุชุฃูุฏ ูู ุฅุฏุฎุงู gemini_api_key.")))
    client = None

# ----------------------------------------------------------------
# 2. ุงูุฏูุงู ุงููุงุฒูุฉ ูุนูู ุงูุชุทุจูู
# ----------------------------------------------------------------

def fix_arabic(text):
    """ูุนุงูุฌ ุงููุตูุต ุงูุนุฑุจูุฉ ูุถูุงู ุงูุนุฑุถ ุงูุตุญูุญ (ูู ุงููููู ูููุณุงุฑ)."""
    if isinstance(text, str):
        reshaped_text = reshape(text)
        return get_display(reshaped_text)
    return text

def get_llm_multimodal_output(uploaded_file, client):
    """
    ูููู ุจุชุญููู ููู PDF ุฅูู Gemini Files APIุ ูุณุชุฎูุต ุงูุจูุงูุงุช ุจุตูุบุฉ JSONุ
    ุซู ูุญุฐู ุงูููู ุงููุคูุช.
    """
    if not client:
        return None

    st.info(fix_arabic("โณ ุฌุงุฑู ุชุญููู ููู PDF ุฅูู Gemini ูุจุฏุก ุงูุชุญููู..."))

    pdf_file = None
    try:
        # 1. ุชุญููู ุงูููู ุฅูู Gemini Files API
        pdf_file = client.files.upload(file=uploaded_file.read(), display_name=uploaded_file.name)
        st.success(fix_arabic(f"โ ุชู ุชุญููู ุงูููู ุจูุฌุงุญ ูู {pdf_file.name}"))

        # 2. ุฑุณุงูุฉ ุงููุธุงู ูุงูุชุนูููุงุช
        system_prompt = ("ุฃูุช ูุญุฑู ุชุญููู ูุงุณุชุฎูุงุต ุจูุงูุงุช ูุชููุฒ ููุชุฎุตุต ูู ูุนุงูุฌุฉ ูุตูุต OCR ุงูุนุฑุจูุฉ "
                         "ุงููุดูุดุฉ ูุงูููููุจุฉ. ูููุชู ูู ูุฑุงุกุฉ ุงูููู ุงููุฑูู ูุชุญููู ูุญุชูุงู ุงูุจุตุฑู ูุงููุตู ุจุฏูุฉ. "
                         "ูู ุจุชุตุญูุญ ุฃู ุงูุนูุงุณ (Bidi reversal) ุฃู ุชุดููุด ูู ุงููุต ุงูุนุฑุจู. ูุฌุจ ุฃู ุชููู ุงููุฎุฑุฌุงุช JSON ููู ููุทุ ูุง ููุฌุฏ ุฃู ูุต ุขุฎุฑ ุฎุงุฑุฌ ุฃููุงุณ {{}}.")

        prompt = """
        ุจุงูุชุทุจูู ุงูุตุงุฑู ูุชุนูููุงุช ุงููุธุงูุ ูู ุจุชุญููู ููู PDF ุงููุฑูู.
        
        **ุชูุฌููุงุช ุงูุจุญุซ ุงูุนุงูุฉ (ุงูู 20 ุญููุงู ุงููุทููุจ ุงุณุชุฎูุงุตูุง):**
        1.  **ุงุณู ุงููุดุชุจู ุจู:** ุงุณุชุฎุฑุฌ **ุงูุงุณู ุงููุงูู** (ุซูุงุซู ุฃู ุฑุจุงุนู) ูููุดุชุจู ุจู ููุง ูุธูุฑ ุจุฌูุงุฑ ุนุจุงุฑุฉ 'ุงููุงูุฏ /' ุฃู 'ุงุณู ุงูุนููู'.
        2.  **ุฑูู ุงููููุฉ:** ุงุณุชุฎุฑุฌ ุฑูู ุงููููุฉ/ุงูุฅูุงูุฉ ุงููุงูุฏ ุงููููู ูู 10 ุฃุฑูุงู.
        3.  **ุงูุฌูุณูุฉ:** ุงุณุชุฎุฑุฌ ุงูุฌูุณูุฉ ููุง ุชุธูุฑ ูู ุญูู 'ุงูุฌูุณูุฉ'.
        4.  **ุชุงุฑูุฎ ุงููููุงุฏ ุงููุงูุฏ:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ูููุงุฏ ุงููุงูุฏ/ุงููุดุชุจู ุจู.
        5.  **ุชุงุฑูุฎ ุงูุฏุฎูู:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ุฏุฎูู ุงููุงูุฏ ููููููุฉ.
        6.  **ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ:** ุงุณุชุฎุฑุฌ ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ ูููุงูุฏ.
        7.  **ุงููููุฉ:** ุงุณุชุฎุฑุฌ ุงููููุฉ ููุง ุชุธูุฑ ูู ุงููุณุชูุฏ.
        8.  **ุฑูู ุงูุฌูุงู:** ุงุณุชุฎุฑุฌ ุฑูู ุงูุฌูุงู/ุงููุงุชู ุฅู ููุฌุฏ.
        9.  **ุงููุฏููุฉ:** ุงุณุชุฎุฑุฌ ูุฏููุฉ ุฅูุงูุฉ ุงูุนููู ุฃู ุงููุฏููุฉ ุงูุฃูุถุญ.
        10. **ุฑุตูุฏ ุงูุญุณุงุจ:** ุงุณุชุฎุฑุฌ ุงูุฑุตูุฏ ุงูููุงุฆู ููุญุณุงุจ.
        11. **ุงูุฏุฎู ุงูุณููู:** ุงุณุชุฎุฑุฌ ูููุฉ "ุฅุฌูุงูู ุงูุนูููุงุช ุงููุถุงูุฉ ูุญุณุงุจ..." ูุชูุฏูุฑ ููุฏุฎู ุงูุณููู.
        12. **ุฑูู ุงูุตุงุฏุฑ:** ุงุณุชุฎุฑุฌ ุงูุฑูู ุงููููู ูู ูฆ ุฃุฑูุงู ุงูุฐู ูุธูุฑ ุจุนุฏ ูููุฉ 'ุฑูู ุงูุตุงุฏุฑ' ูู ุฃุนูู ุงููุณุชูุฏ.
        13. **ุชุงุฑูุฎ ุงูุตุงุฏุฑ:** ุงุณุชุฎุฑุฌ ุงูุชุงุฑูุฎ ุงููุฌุฑู ุงูุฐู ูุธูุฑ ุจุฌูุงุฑ ุญูู "ุงูุชุงุฑูุฎ" ุงููุตุงุญุจ ูู "ุฑูู ุงูุตุงุฏุฑ".
        14. **ุฑูู ุงููุงุฑุฏ:** ุงุณุชุฎุฑุฌ ุฑูู ุงูุฎุทุงุจ ุฃู **ุฑูู ุงููุงุฑุฏ** ุงูุฐู ูุธูุฑ ูู ุฎุชู ูุฒุงุฑุฉ ุงูุชุฌุงุฑุฉ.
        15. **ุชุงุฑูุฎ ุงููุงุฑุฏ:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ูุตูู ุงูุฎุทุงุจ (ุงูุชุงุฑูุฎ ุงููุตุงุญุจ ูู "ุฑูู ุงููุงุฑุฏ").
        16. **ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู:** ุงุณุชุฎุฑุฌ ุฑูู ุงูุณุฌู ุงูุชุฌุงุฑู ููููุดุฃุฉ ุฃู ุฑูู ุตุงุญุจ ุงูุนูู.
        17. **ุณุจุจ ุงูุงุดุชุจุงู:** ุงุณุชุฎุฑุฌ **ุงูููุฑุฉ ุงููุตูุฉ ุงููุตููุฉ ุงููุงููุฉ ูุงูููุตูุฉ** ุงูุชู ุชุตู ุณุจุจ ุงูุงุดุชุจุงู.
        18. **ุชุงุฑูุฎ ุงูุฏุงุฑุณุฉ ูู:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ุจุฏุงูุฉ ูุชุฑุฉ ุงูุฏุฑุงุณุฉ.
        19. **ุชุงุฑูุฎ ุงูุฏุฑุงุณุฉ ุงูู:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ููุงูุฉ ูุชุฑุฉ ุงูุฏุฑุงุณุฉ.
        20. **ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ:** ุงุณุชุฎุฑุฌ ูููุฉ "ุฅุฌูุงูู ุงูุนูููุงุช ุงููุถุงูุฉ" ุฃู "ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ".
        
        **ููุงุญุธุฉ:** ุฅุฐุง ูู ุชุฌุฏ ูููุฉ ุตุฑูุญุฉ ูุฃู ุญููุ ุถุน ุงููููุฉ: 'ุบูุฑ ูุชููุฑ'.
        
        ุงูุฑุฌุงุก ุชูุฏูู ุงูุฅุฌุงุจุฉ ุจุชูุณูู JSON ููู (ุฏูู ุฃู ูุต ุฅุถุงูู):
        {
          "ุฑูู ุงูุตุงุฏุฑ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุชุงุฑูุฎ ุงูุตุงุฏุฑ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุงุณู ุงููุดุชุจู ุจู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ูุงููุฉ.",
          "ุฑูู ุงููููุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุงูุฌูุณูุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุชุงุฑูุฎ ุงููููุงุฏ ุงููุงูุฏ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุชุงุฑูุฎ ุงูุฏุฎูู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุงููููุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุฑูู ุงูุฌูุงู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุงููุฏููุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุฑุตูุฏ ุงูุญุณุงุจ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ุจุงูุฑูุงู.",
          "ุงูุฏุฎู ุงูุณููู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ุจุงูุฑูุงู.",
          "ุฑูู ุงููุงุฑุฏ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุชุงุฑูุฎ ุงููุงุฑุฏ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุณุจุจ ุงูุงุดุชุจุงู": "ุงูููุฑุฉ ุงููุตูุฉ ุงููุตููุฉ ุงููุงููุฉ.",
          "ุชุงุฑูุฎ ุงูุฏุงุฑุณุฉ ูู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุชุงุฑูุฎ ุงูุฏุฑุงุณุฉ ุงูู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
          "ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ุจุงูุฑูุงู."
        }
        """

        # 3. ุฅุนุฏุงุฏ ูููุฐุฌ ุงูู JSON
        response_schema = types.GenerateContentConfig(
            response_mime_type="application/json",
            system_instruction=system_prompt,
            temperature=0.3
        )

        # 4. ุชูููุฏ ุงููุญุชูู ุจุงุณุชุฎุฏุงู ูููุฐุฌ gemini-2.5-pro
        response = client.models.generate_content(
            model='gemini-2.5-pro',
            contents=[pdf_file, prompt],
            config=response_schema
        )
        
        # 5. ุชูุธูู ูุชุญููู JSON
        response_text = response.text.replace('\n', '').strip()
        extracted_data = json.loads(response_text)
        return extracted_data

    except Exception as e:
        st.error(fix_arabic(f"๐จ ุฎุทุฃ ูู ุงูุงุณุชุฎูุงุต ุนุจุฑ ุงูุชุญููู ูุชุนุฏุฏ ุงููุณุงุฆุท: {e}"))
        return None
        
    finally:
        # 6. ุญุฐู ุงูููู ุงููุคูุช ุจุนุฏ ุงูุงูุชูุงุก (ููู ููุฃูุงู)
        if pdf_file:
            try:
                client.files.delete(name=pdf_file.name)
                st.info(fix_arabic(f"โ ุชู ุญุฐู ุงูููู ุงููุคูุช {pdf_file.name}."))
            except Exception as e:
                st.warning(fix_arabic(f"โ๏ธ ูุดู ูู ุญุฐู ุงูููู ุงููุคูุช {pdf_file.name}: {e}"))


def create_final_report(extracted_data):
    """ููุดุฆ ููู Excel ูู ุงูุจูุงูุงุช ุงููุณุชุฎูุตุฉ ููุถูู ุงูุชูุณูู ุงูุนุฑุจู."""
    if not extracted_data:
        return None
        
    # ุชุญุฏูุฏ ุงูุชุฑุชูุจ ุงูุฏููู ููุฃุนูุฏุฉ
    column_order = ["#", "ุฑูู ุงูุตุงุฏุฑ", "ุชุงุฑูุฎ ุงูุตุงุฏุฑ", "ุงุณู ุงููุดุชุจู ุจู", "ุฑูู ุงููููุฉ",
                    "ุงูุฌูุณูุฉ", "ุชุงุฑูุฎ ุงููููุงุฏ ุงููุงูุฏ", "ุชุงุฑูุฎ ุงูุฏุฎูู", "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ",
                    "ุงููููุฉ", "ุฑูู ุงูุฌูุงู", "ุงููุฏููุฉ", "ุฑุตูุฏ ุงูุญุณุงุจ", "ุงูุฏุฎู ุงูุณููู",
                    "ุฑูู ุงููุงุฑุฏ", "ุชุงุฑูุฎ ุงููุงุฑุฏ", "ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู",
                    "ุณุจุจ ุงูุงุดุชุจุงู", "ุชุงุฑูุฎ ุงูุฏุงุฑุณุฉ ูู", "ุชุงุฑูุฎ ุงูุฏุฑุงุณุฉ ุงูู",
                    "ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ"]
    
    # ุชุญููู ุงูุจูุงูุงุช ุฅูู DataFrame
    df = pd.DataFrame([extracted_data])
    df.insert(0, '#', 1) # ุฅุถุงูุฉ ุนููุฏ ุงูุชุฑููู
    
    # ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูุฃุนูุฏุฉ ูุฅุถุงูุฉ ุงูุฃุนูุฏุฉ ุงูููููุฏุฉ ุจูููุฉ ูุงุฑุบุฉ
    final_cols = []
    for col in column_order:
        if col in df.columns: final_cols.append(col)
        elif col == "ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู" and "ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู" in df.columns:
             final_cols.append("ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู")
        elif col not in df.columns:
            df[col] = ''
            final_cols.append(col)
            
    df = df[final_cols]
    
    output = io.BytesIO()
    
    try:
        # ุงุณุชุฎุฏุงู xlsxwriter ูุฏุนู ุชูุณูู RTL
        writer = pd.ExcelWriter(output, engine='xlsxwriter')
        df.to_excel(writer, sheet_name=fix_arabic('ุงูุชูุฑูุฑ ุงููุงูู'), index=False)
        
        workbook  = writer.book
        worksheet = writer.sheets[fix_arabic('ุงูุชูุฑูุฑ ุงููุงูู')]
        
        # ุชูุนูู ุฎุงุตูุฉ ุงูู RTL ูููุฑูุฉ
        worksheet.right_to_left()

        # ุชูุณูู ุงูุนููุฏ ุงูุฎุงุต ุจู "ุณุจุจ ุงูุงุดุชุจุงู" ูููุงุฆู ุงููุต ุงูุทููู
        col_format = workbook.add_format({'text_wrap': True, 'align': 'right', 'valign': 'top'})
        worksheet.set_column(17, 17, 60, col_format)
        
        writer.close()
        output.seek(0)
        
        return output.read()
        
    except Exception as e:
        st.error(fix_arabic(f"๐จ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ููู Excel: {e}"))
        return None

# ----------------------------------------------------------------
# 3. ูุงุฌูุฉ Streamlit ุงูุฑุฆูุณูุฉ
# ----------------------------------------------------------------

def main():
    st.set_page_config(page_title=fix_arabic("ุงุณุชุฎูุงุต ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุขูู"), layout="wide")
    st.title(fix_arabic("ุงุณุชุฎูุงุต ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุขูู ๐ค"))
    st.markdown("---")
    
    # ุงูุชุญูู ูู ุชููุฆุฉ ุงูุนููู
    if 'client' not in globals() or not client:
        st.stop()
        
    uploaded_file = st.file_uploader(
        fix_arabic("๐ ูู ุจุชุญููู ููู ุงูุชูุฑูุฑ ุงููุงูู (PDF) ููุง:"),
        type=["pdf"],
        accept_multiple_files=False
    )

    if uploaded_file is not None:
        st.success(fix_arabic(f"ุชู ุชุญููู ููู: {uploaded_file.name}"))
        
        if st.button(fix_arabic("๐ ุจุฏุก ุงูุงุณุชุฎูุงุต ูุงูุชุญููู ุฅูู Excel"), key="start_extraction"):
            
            with st.spinner(fix_arabic('โณ ุฌุงุฑู ุชุญููู ูุงุณุชุฎูุงุต ุงูุจูุงูุงุช ูุชุฌููุฒ ุงูุชูุฑูุฑ... (ูุฏ ูุณุชุบุฑู 30-60 ุซุงููุฉ)')):
                
                extracted_data = get_llm_multimodal_output(uploaded_file, client)
                
                if extracted_data:
                    st.subheader(fix_arabic("โ ุงูุจูุงูุงุช ุงููุณุชุฎูุตุฉ (ุชุญูู ุณุฑูุน)"))
                    st.json(extracted_data)
                    
                    excel_data_bytes = create_final_report(extracted_data)
                    
                    if excel_data_bytes:
                        st.subheader(fix_arabic("๐ ุงูุชูุฑูุฑ ุฌุงูุฒ ููุชุญููู"))
                        st.balloons()
                        
                        st.download_button(
                            label=fix_arabic("โฌ๏ธ ุชุญููู ููู ุงูุชูุฑูุฑ ุงูููุงุฆู (Excel)"),
                            data=excel_data_bytes,
                            file_name=f"{uploaded_file.name.replace('.pdf', '')}_Extracted_Data.xlsx",
                            mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                        )
                    else:
                        st.error(fix_arabic("โ ูุดู ูู ุฅูุดุงุก ููู Excel. ุงูุฑุฌุงุก ูุฑุงุฌุนุฉ ุณุฌู ุงูุฃุฎุทุงุก."))

if __name__ == '__main__':
    main()
