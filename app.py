import streamlit as st
import pandas as pd
from google import genai
from google.genai import types
from google.genai.errors import APIError
from arabic_reshaper import reshape
from bidi.algorithm import get_display
import os
import json
import io
import sys
import xlsxwriter # ูุชู ุงุณุชุฎุฏุงูู ูู create_final_report

# ----------------------------------------------------------------
# 1. ุฅุนุฏุงุฏุงุช API ูุงููุตูุต ุงูุนุฑุจูุฉ
# ----------------------------------------------------------------

# ุงูุชููุฆุฉ ุงูุขููุฉ ูุนููู Gemini (ูุนุชูุฏ ุนูู ุงูููุชุงุญ ุงููุชุงุญ ูู ุจูุฆุฉ Canvas)
try:
    # ุชููุฆุฉ ุงูุนููู. ุณูููู ุจุงูุจุญุซ ุนู ุงูููุชุงุญ ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ.
    # ูุณุชุฎุฏู gemini.Client() ุจุฏูุงู ูู genai.Client() ุฅุฐุง ูุงูุช ุงูููุชุจุฉ ูู google-gemini
    client = genai.Client() 
except Exception as e:
    # ุฑุณุงูุฉ ุฎุทุฃ ูุน ูุนุงูุฌุฉ ุงููุต ุงูุนุฑุจู
    st.error(get_display(reshape(f"ูุดู ูู ุชููุฆุฉ ุนููู Gemini: {e}")))
    client = None

def fix_arabic(text):
    """ูุนุงูุฌ ุงููุตูุต ุงูุนุฑุจูุฉ ูุถูุงู ุงูุนุฑุถ ุงูุตุญูุญ (ูู ุงููููู ูููุณุงุฑ)."""
    if isinstance(text, str) and text:
        reshaped_text = reshape(text)
        return get_display(reshaped_text)
    return text

# ----------------------------------------------------------------
# 2. ูุธููุฉ ุงูุงุณุชุฎูุงุต ุนุจุฑ Gemini (Multimodal)
# ----------------------------------------------------------------

def get_llm_multimodal_output(uploaded_file, client):
    """
    ูุฑูุน ููู PDF ุฅูู Geminiุ ููุทูุจ ููู ุงุณุชุฎูุงุต ุงูู 20 ุญููุงู ุงููุญุฏุฏุฉ ุจุชูุณูู JSON.
    """
    if client is None:
        st.error(fix_arabic("๐จ ูุง ูููู ุงูุชูุงุตู ูุน Gemini. ุงูุฑุฌุงุก ุงูุชุญูู ูู ุชููุฆุฉ API."))
        return None

    st.info(fix_arabic("โณ ุฌุงุฑู ุชุญููู ููู PDF ุฅูู Gemini ูุจุฏุก ุงูุงุณุชุฎูุงุต ูุงูุชุญููู ุงูุจุตุฑู..."))

    pdf_file = None
    try:
        # 1. ุฑูุน ุงูููู
        uploaded_file.seek(0) # ุงูุชุฃูุฏ ูู ูุฑุงุกุฉ ุงูููู ูู ุงูุจุฏุงูุฉ
        pdf_file = client.files.upload(file=uploaded_file.read(), display_name=uploaded_file.name)
        st.success(fix_arabic(f"โ ุชู ุชุญููู ุงูููู ุจูุฌุงุญ ูู {pdf_file.name}"))

        # 2. ุฅุนุฏุงุฏ ุงููุทุงูุจุฉ ููุธุงู ุงูุชุนูููุงุช
        system_prompt = (
            "ุฃูุช ูุญุฑู ุชุญููู ูุงุณุชุฎูุงุต ุจูุงูุงุช ูุชููุฒ ููุชุฎุตุต ูู ูุนุงูุฌุฉ ูุตูุต OCR ุงูุนุฑุจูุฉ "
            "ุงููุดูุดุฉ ูุงูููููุจุฉ. ูููุชู ูู ูุฑุงุกุฉ ุงูููู ุงููุฑูู ูุชุญููู ูุญุชูุงู ุงูุจุตุฑู ูุงููุตู ุจุฏูุฉ. "
            "ูู ุจุชุตุญูุญ ุฃู ุงูุนูุงุณ (Bidi reversal) ุฃู ุชุดููุด ูู ุงููุต ุงูุนุฑุจู. ูุฌุจ ุฃู ุชููู ุงููุฎุฑุฌุงุช JSON ููุท."
        )

        prompt = f"""
        ุจุงูุชุทุจูู ุงูุตุงุฑู ูุชุนูููุงุช ุงููุธุงูุ ูู ุจุชุญููู ููู PDF ุงููุฑูู ูุงุณุชุฎุฑุฌ ุงูุจูุงูุงุช ุญุณุจ ุงูุชูุฌููุงุช ุงูุชุงููุฉ:
        
        **ุชูุฌููุงุช ุงูุจุญุซ (ุงูู 20 ุญููุงู ุงููุทููุจ ุงุณุชุฎูุงุตูุง):**
        1.  **ุงุณู ุงููุดุชุจู ุจู:** ุงุณุชุฎุฑุฌ **ุงูุงุณู ุงููุงูู** (ุซูุงุซู ุฃู ุฑุจุงุนู) ูููุดุชุจู ุจู ููุง ูุธูุฑ ุจุฌูุงุฑ ุนุจุงุฑุฉ 'ุงููุงูุฏ /' ุฃู 'ุงุณู ุงูุนููู'.
        2.  **ุฑูู ุงููููุฉ:** ุงุณุชุฎุฑุฌ ุฑูู ุงููููุฉ/ุงูุฅูุงูุฉ ุงููุงูุฏ ุงููููู ูู 10 ุฃุฑูุงู.
        3.  **ุงูุฌูุณูุฉ:** ุงุณุชุฎุฑุฌ ุงูุฌูุณูุฉ ููุง ุชุธูุฑ ูู ุญูู 'ุงูุฌูุณูุฉ'.
        4.  **ุชุงุฑูุฎ ุงููููุงุฏ ุงููุงูุฏ:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ูููุงุฏ ุงููุงูุฏ/ุงููุดุชุจู ุจู.
        5.  **ุชุงุฑูุฎ ุงูุฏุฎูู:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ุฏุฎูู ุงููุงูุฏ ููููููุฉ.
        6.  **ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ:** ุงุณุชุฎุฑุฌ ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ ูููุงูุฏ.
        7.  **ุงููููุฉ:** ุงุณุชุฎุฑุฌ ุงููููุฉ ููุง ุชุธูุฑ ูู ุงููุณุชูุฏ.
        8.  **ุฑูู ุงูุฌูุงู:** ุงุณุชุฎุฑุฌ ุฑูู ุงูุฌูุงู/ุงููุงุชู ุฅู ููุฌุฏ.
        9.  **ุงููุฏููุฉ:** ุงุณุชุฎุฑุฌ ูุฏููุฉ ุฅูุงูุฉ ุงูุนููู ุฃู ุงููุฏููุฉ ุงูุฃูุถุญ.
        10. **ุฑุตูุฏ ุงูุญุณุงุจ:** ุงุณุชุฎุฑุฌ ุงูุฑุตูุฏ ุงูููุงุฆู ููุญุณุงุจ.
        11. **ุงูุฏุฎู ุงูุณููู:** ุงุณุชุฎุฑุฌ ูููุฉ "ุฅุฌูุงูู ุงูุนูููุงุช ุงููุถุงูุฉ ูุญุณุงุจ..." ูุชูุฏูุฑ ููุฏุฎู ุงูุณููู.
        12. **ุฑูู ุงูุตุงุฏุฑ:** ุงุณุชุฎุฑุฌ ุงูุฑูู ุงููููู ูู ูฆ ุฃุฑูุงู ุงูุฐู ูุธูุฑ ุจุนุฏ ูููุฉ 'ุฑูู ุงูุตุงุฏุฑ' ูู ุฃุนูู ุงููุณุชูุฏ.
        13. **ุชุงุฑูุฎ ุงูุตุงุฏุฑ:** ุงุณุชุฎุฑุฌ ุงูุชุงุฑูุฎ ุงููุฌุฑู ุงูุฐู ูุธูุฑ ุจุฌูุงุฑ ุญูู "ุงูุชุงุฑูุฎ" ุงููุตุงุญุจ ูู "ุฑูู ุงูุตุงุฏุฑ".
        14. **ุฑูู ุงููุงุฑุฏ:** ุงุณุชุฎุฑุฌ ุฑูู ุงูุฎุทุงุจ ุฃู **ุฑูู ุงููุงุฑุฏ** ุงูุฐู ูุธูุฑ ูู ุฎุชู ูุฒุงุฑุฉ ุงูุชุฌุงุฑุฉ.
        15. **ุชุงุฑูุฎ ุงููุงุฑุฏ:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ูุตูู ุงูุฎุทุงุจ (ุงูุชุงุฑูุฎ ุงููุตุงุญุจ ูู "ุฑูู ุงููุงุฑุฏ").
        16. **ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู:** ุงุณุชุฎุฑุฌ ุฑูู ุงูุณุฌู ุงูุชุฌุงุฑู ููููุดุฃุฉ ุฃู ุฑูู ุตุงุญุจ ุงูุนูู.
        17. **ุณุจุจ ุงูุงุดุชุจุงู:** ุงุณุชุฎุฑุฌ **ุงูููุฑุฉ ุงููุตูุฉ ุงููุตููุฉ ุงููุงููุฉ ูุงูููุตูุฉ** ุงูุชู ุชุตู ุณุจุจ ุงูุงุดุชุจุงู.
        18. **ุชุงุฑูุฎ ุงูุฏุงุฑุณุฉ ูู:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ุจุฏุงูุฉ ูุชุฑุฉ ุงูุฏุฑุงุณุฉ.
        19. **ุชุงุฑูุฎ ุงูุฏุฑุงุณุฉ ุงูู:** ุงุณุชุฎุฑุฌ ุชุงุฑูุฎ ููุงูุฉ ูุชุฑุฉ ุงูุฏุฑุงุณุฉ.
        20. **ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ:** ุงุณุชุฎุฑุฌ ูููุฉ "ุฅุฌูุงูู ุงูุนูููุงุช ุงููุถุงูุฉ" ุฃู "ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ".
        
        **ููุงุญุธุฉ:** ุฅุฐุง ูู ุชุฌุฏ ูููุฉ ุตุฑูุญุฉ ูุฃู ุญููุ ุถุน ุงููููุฉ: 'ุบูุฑ ูุชููุฑ'.
        
        ุงูุฑุฌุงุก ุชูุฏูู ุงูุฅุฌุงุจุฉ ุจุชูุณูู JSON ููู (ุฏูู ุฃู ูุต ุฅุถุงูู):
        {{
            "ุฑูู ุงูุตุงุฏุฑ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุชุงุฑูุฎ ุงูุตุงุฏุฑ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุงุณู ุงููุดุชุจู ุจู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ูุงููุฉ.",
            "ุฑูู ุงููููุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุงูุฌูุณูุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุชุงุฑูุฎ ุงููููุงุฏ ุงููุงูุฏ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุชุงุฑูุฎ ุงูุฏุฎูู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุงููููุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุฑูู ุงูุฌูุงู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุงููุฏููุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุฑุตูุฏ ุงูุญุณุงุจ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ุจุงูุฑูุงู.",
            "ุงูุฏุฎู ุงูุณููู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ุจุงูุฑูุงู.",
            "ุฑูู ุงููุงุฑุฏ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุชุงุฑูุฎ ุงููุงุฑุฏ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุณุจุจ ุงูุงุดุชุจุงู": "ุงูููุฑุฉ ุงููุตูุฉ ุงููุตููุฉ ุงููุงููุฉ.",
            "ุชุงุฑูุฎ ุงูุฏุงุฑุณุฉ ูู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุชุงุฑูุฎ ุงูุฏุฑุงุณุฉ ุงูู": "ุงููููุฉ ุงููุณุชุฎูุตุฉ.",
            "ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ": "ุงููููุฉ ุงููุณุชุฎูุตุฉ ุจุงูุฑูุงู."
        }}
        """

        # 3. ุฅุนุฏุงุฏุงุช ุงุณุชุฌุงุจุฉ JSON
        response_config = types.GenerateContentConfig(
            response_mime_type="application/json",
            system_instruction=system_prompt,
            temperature=0.3
        )
        
        # 4. ุฅุฑุณุงู ุงูุทูุจ (ููู + ูุต ุงููุทุงูุจุฉ)
        response = client.models.generate_content(
            model='gemini-2.5-pro',
            contents=[pdf_file, prompt],
            config=response_config
        )

        response_text = response.text.replace('\n', '').strip()
        
        # ุงูุชุฃูุฏ ูู ุฃู ุงููุต ูุจุฏุฃ ูููุชูู ุจุฃููุงุณ JSON ุซู ุชุญูููู
        if response_text.startswith('{') and response_text.endswith('}'):
             extracted_data = json.loads(response_text)
             return extracted_data
        else:
            st.error(fix_arabic(f"ูุดู ูู ุงุณุชุฎูุงุต ุจูุงูุงุช JSON. ุชู ุงูุญุตูู ุนูู ุงููุต: {response_text[:100]}..."))
            return None

    except APIError as e:
        st.error(fix_arabic(f"๐จ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Gemini API: {e}"))
        return None
    except json.JSONDecodeError:
        st.error(fix_arabic("๐จ ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช JSON ุงููุณุชุฎูุตุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู."))
        return None
    except Exception as e:
        st.error(fix_arabic(f"๐จ ุฎุทุฃ ุบูุฑ ูุชููุน ุฃุซูุงุก ุงูุงุณุชุฎูุงุต: {e}"))
        return None
        
    finally:
        # 5. ุญุฐู ุงูููู ุงููุคูุช ูู ุฎูุงุฏู Gemini (ููู ุฌุฏุงู ููุชูุธูู)
        if pdf_file is not None:
            try:
                client.files.delete(name=pdf_file.name)
                st.info(fix_arabic(f"โ ุชู ุญุฐู ุงูููู ุงููุคูุช {pdf_file.name}."))
            except Exception as e:
                st.warning(fix_arabic(f"ูู ูุชููู ูู ุญุฐู ุงูููู ุงููุคูุช: {e}"))


# ----------------------------------------------------------------
# 3. ูุธููุฉ ุฅูุดุงุก ุชูุฑูุฑ Excel
# ----------------------------------------------------------------

def create_final_report(extracted_data):
    """
    ูุญูู ุจูุงูุงุช JSON ุงููุณุชุฎูุตุฉ ุฅูู DataFrameุ ูุถุจุท ุชุฑุชูุจ ุงูุฃุนูุฏุฉุ ูููุดุฆ ููู Excel (xlsx).
    """
    if not extracted_data:
        return None
        
    # ููุณ ุชุฑุชูุจ ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ ุจุงูุถุจุท
    column_order = [
        "#", "ุฑูู ุงูุตุงุฏุฑ", "ุชุงุฑูุฎ ุงูุตุงุฏุฑ", "ุงุณู ุงููุดุชุจู ุจู", "ุฑูู ุงููููุฉ",
        "ุงูุฌูุณูุฉ", "ุชุงุฑูุฎ ุงููููุงุฏ ุงููุงูุฏ", "ุชุงุฑูุฎ ุงูุฏุฎูู", "ุงูุญุงูุฉ ุงูุงุฌุชูุงุนูุฉ",
        "ุงููููุฉ", "ุฑูู ุงูุฌูุงู", "ุงููุฏููุฉ", "ุฑุตูุฏ ุงูุญุณุงุจ", "ุงูุฏุฎู ุงูุณููู",
        "ุฑูู ุงููุงุฑุฏ", "ุชุงุฑูุฎ ุงููุงุฑุฏ", "ุฑูู ุตุงุญุจ ุงูุนูู/ ุงูุณุฌู ุงูุชุฌุงุฑู",
        "ุณุจุจ ุงูุงุดุชุจุงู", "ุชุงุฑูุฎ ุงูุฏุงุฑุณุฉ ูู", "ุชุงุฑูุฎ ุงูุฏุฑุงุณุฉ ุงูู",
        "ุฅุฌูุงูู ุงูุฅูุฏุงุน ุนูู ุงูุญุณุงุจ ุงุซูุงุก ุงูุฏุฑุงุณุฉ"
    ]
    
    # ุชุญููู ุงููุงููุณ ุฅูู DataFrame
    df = pd.DataFrame([extracted_data])
    
    # ุฅุถุงูุฉ ุงูุนููุฏ # (ุจูุงุกู ุนูู ููุฏ Colabุ ุณูุถููู ูุนููุฏ ุฑูู 1)
    df.insert(0, '#', 1) 
    
    # ุถูุงู ูุฌูุฏ ุฌููุน ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ ูู DataFrame ุจุงูุชุฑุชูุจ ุงูุตุญูุญ
    final_cols = []
    for col in column_order:
        # ุฅุฐุง ูุงู ุงูุนููุฏ ููุฌูุฏุงู (ููุฐุง ูู ุงููุชููุน ูู ูุฎุฑุฌ Gemini)ุ ูุถููู
        if col in df.columns:
            final_cols.append(col)
        # ุฅุฐุง ูุงู ููููุฏุงูุ ูุถููู ุจููู ูุงุฑุบุฉ (ูู ูุญุฏุซ ูุฐุง ุฅุฐุง ูุงู Gemini ูุนูู ุจุดูู ุตุญูุญ)
        else:
            df[col] = ''
            final_cols.append(col)
            
    # ุชุทุจูู ุงูุชุฑุชูุจ ุงูููุงุฆู
    df = df[final_cols]
    
    # ุชุทุจูู ุฏุงูุฉ fix_arabic ุนูู ุฌููุน ุงูููู ุงููุตูุฉ ูุจู ุงูุชุตุฏูุฑ
    for col in df.columns:
        if df[col].dtype == 'object':
            df[col] = df[col].apply(lambda x: get_display(reshape(str(x))) if pd.notna(x) else x)
            
    # ุฅูุดุงุก ูุฎุฑุฌ Excel ูู ุงูุฐุงูุฑุฉ
    output = io.BytesIO()
    
    try:
        writer = pd.ExcelWriter(output, engine='xlsxwriter')
        df.to_excel(writer, sheet_name=fix_arabic('ุงูุชูุฑูุฑ ุงููุงูู'), index=False)
        
        # ุชููุฆุฉ ุงูุชูุณูู ูููู Excel
        workbook  = writer.book
        worksheet = writer.sheets[fix_arabic('ุงูุชูุฑูุฑ ุงููุงูู')]
        worksheet.right_to_left()

        # ุชูุณูู ุงูุนููุฏ 18 (ุณุจุจ ุงูุงุดุชุจุงู) ููููู ููุชูุงู ููุงุณุนุงู
        # ุฃุนูุฏุฉ pandas ุชุจุฏุฃ ูู 0ุ ุงูุนููุฏ 17 ูู ุณุจุจ ุงูุงุดุชุจุงู
        col_format = workbook.add_format({'text_wrap': True, 'align': 'right', 'valign': 'top'})
        worksheet.set_column(17, 17, 60, col_format) 
        
        writer.close()
        output.seek(0)
        
        return output.read()
        
    except Exception as e:
        st.error(fix_arabic(f"๐จ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ููู Excel: {e}"))
        return None

# ----------------------------------------------------------------
# 4. ูุงุฌูุฉ ุงูุชุทุจูู ุงูุฑุฆูุณูุฉ (Streamlit)
# ----------------------------------------------------------------

def main():
    st.set_page_config(page_title=fix_arabic("ุฃุชูุชุฉ ุงุณุชุฎูุงุต ุงูุชูุงุฑูุฑ ุงููุงููุฉ"), layout="wide")
    st.markdown(f"<h1 style='text-align: right;'>{fix_arabic('ุงุณุชุฎูุงุต ุงูุชูุงุฑูุฑ ุงููุงููุฉ ุงูุขูู ๐ค')}</h1>", unsafe_allow_html=True)
    st.markdown("---")
    
    uploaded_file = st.file_uploader(
        fix_arabic("๐ ูู ุจุชุญููู ููู ุงูุชูุฑูุฑ ุงููุงูู (PDF/Excel) ููุง:"),
        type=["pdf", "xlsx", "xls", "csv"],
        accept_multiple_files=False
    )

    if uploaded_file is not None:
        st.success(fix_arabic(f"ุชู ุชุญููู ููู: {uploaded_file.name}"))
        
        # ููุงุญุธุฉ: ุชู ุญุฐู ููุทู ูุฑุงุกุฉ CSV/Excel ุงููุจุงุดุฑ ูุชู ุงูุงุนุชูุงุฏ ุนูู
        # Gemini API ููุฑุงุกุฉ ุงููุต ุฃููุงู ูุถูุงู ุงูุฏูุฉ ูู ุงูุงุณุชุฎูุงุต ููุง ูู ูููุฐุฌ Colab.
        
        if uploaded_file.type not in ["application/pdf"]:
             st.warning(fix_arabic("ุชู ุชุตููู ุงูุฃุฏุงุฉ ููุงุณุชุฎูุงุต ูู ูููุงุช PDF ุงูุชู ูุฏ ุชุญุชูู ุนูู ูุตูุต ูุดูุดุฉ. ูุชุญููู ูููุงุช Excel/CSVุ ุณูุชู ุฅุฑุณุงู ูุญุชูุงูุง ุงููุตู ูู Gemini."))

        if st.button(fix_arabic("๐ ุจุฏุก ุงูุงุณุชุฎูุงุต ูุงูุชุญููู ุฅูู Excel"), key="start_extraction"):
            
            with st.spinner(fix_arabic('โณ ุฌุงุฑู ุชุญููู ูุงุณุชุฎูุงุต ุงูุจูุงูุงุช ูุชุฌููุฒ ุงูุชูุฑูุฑ... (ูุฏ ูุณุชุบุฑู 30-60 ุซุงููุฉ)')):
                
                # ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุงุณุชุฎูุงุต ุนุจุฑ Gemini
                extracted_data = get_llm_multimodal_output(uploaded_file, client)
                
                if extracted_data:
                    st.subheader(fix_arabic("โ ุงูุจูุงูุงุช ุงููุณุชุฎูุตุฉ (ุชุญูู ุณุฑูุน)"))
                    # ูููู ุจุชุทุจูู fix_arabic ุนูู ููุงุชูุญ ูููู ุงูู JSON ููุนุฑุถ ูู Streamlit
                    reshaped_data = {fix_arabic(k): fix_arabic(v) for k, v in extracted_data.items()}
                    st.json(reshaped_data)
                    
                    excel_data_bytes = create_final_report(extracted_data)
                    
                    if excel_data_bytes:
                        st.subheader(fix_arabic("๐ ุงูุชูุฑูุฑ ุฌุงูุฒ ููุชุญููู"))
                        st.balloons()
                        
                        st.download_button(
                            label=fix_arabic("โฌ๏ธ ุชุญููู ููู ุงูุชูุฑูุฑ ุงูููุงุฆู (Excel)"),
                            data=excel_data_bytes,
                            file_name=f"{uploaded_file.name.replace('.pdf', '')}_Extracted_Data.xlsx",
                            mime='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                        )
                    else:
                        st.error(fix_arabic("โ ูุดู ูู ุฅูุดุงุก ููู Excel. ุงูุฑุฌุงุก ูุฑุงุฌุนุฉ ุณุฌู ุงูุฃุฎุทุงุก."))

if __name__ == '__main__':
    main()
